<!DOCTYPE html>
<html>
<head></head>
<body>
<input type="text" id="url"/>
<script>
  // ICON clicked
  chrome.pageAction.onClicked.addListener(function(tab) {
    // We're processing...
    setTab('loading.png', 'Processing...', tab);
    shortenURL(tab.url, function (e, s) {
      if (!e) { // No error!
        setTab('16.png', 'Lyhennä osoite!', tab);
        copyToClipboard(s);
        var notification = webkitNotifications.createHTMLNotification('note.html#' + s);
        notification.show();
      } else { // Error :/
        setTab('stop.png', 'Failed!', tab);
        var notification = webkitNotifications.createNotification(
            'stop.png',
            'Failed!',
            "I'm terribly sorry, try again later!"
        );
        notification.show();
        // Hide error message and reset icon after a while
        setTimeout(function () {
          notification.cancel();
          setTab('16.png', 'Lyhennä osoite!', tab);
        }, 10000);
      }
    });
  });
  // Show the icon
  chrome.tabs.onUpdated.addListener(function(tabId) {
    chrome.pageAction.show(tabId);
  });

  // SHORTEN url and callback
  function shortenURL(url, cb) {
    var xhr = new XMLHttpRequest(),
        urly = 'http://urly.fi/api/shorten/?url=' + escape(url);
    xhr.onreadystatechange = function() {
    if (xhr.readyState == 4) {
      if (xhr.status == 200) {
        cb(false, 'http://urly.fi/' + xhr.responseText);
      } else {
        cb(true, 'Error!');
      }
    }
    }
    xhr.open('GET', urly, true);
    xhr.send();
  }

  function copyToClipboard(text) {
    var input = document.getElementById('url');
    
    if(input == undefined)
        return;
    
    input.value = text;                 
    input.select();

    document.execCommand('copy', false, null);
  }
  
  // OMNIBOX keyword: url
  chrome.omnibox.onInputEntered.addListener(function(text) {
    shortenURL(text, function (e, s) {
      if (!e) {
        copyToClipboard(s);
        var notification = webkitNotifications.createHTMLNotification('note.html#' + s);
        notification.show();
      } else {
        var notification = webkitNotifications.createNotification(
            'stop.png',
            'Failed!',
            "I'm terribly sorry, try again later!"
        );
        notification.show();
        setTimeout(function () {notification.cancel();}, 10000);
      }
    });
  });

  function setTab(i, t, tab) {
    chrome.pageAction.setIcon({path: i, tabId: tab.id});
    chrome.pageAction.setTitle({title: t, tabId: tab.id});
  };
</script>
</body>