<!DOCTYPE html>
<!--
    Chromerly is a Chrome Extension to utilize the Finnish urly.fi.
    Copyright (C) 2011  Ville 'tuhoojabotti' Lahdenvuo

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
<head></head>
<body>
<!-- Our input box for copying to clipboard -->
<input type="text" id="url"/>
<!-- The magic to make it all happen -->
<script>
  // INIT - Create context menus
  window.onload = function () {
    chrome.contextMenus.create({ //// PAGE
        "title": chrome.i18n.getMessage('ContextPage'),
        "contexts": ["page"], "onclick": handleContextPage});
    chrome.contextMenus.create({ //// SELECTION
        "title": chrome.i18n.getMessage('ContextSelection'),
        "contexts": ["selection"], "onclick": handleContextSel});
    chrome.contextMenus.create({ //// LINK
        "title": chrome.i18n.getMessage('ContextLink'),
        "contexts": ["link"], "onclick": handleContextLink});
    chrome.contextMenus.create({ //// IMAGE
        "title": chrome.i18n.getMessage('ContextImage'),
        "contexts": ["image"], "onclick": handleContextMedia});
    chrome.contextMenus.create({ //// VIDEO
        "title": chrome.i18n.getMessage('ContextVideo'),
        "contexts": ["video"], "onclick": handleContextMedia});
    chrome.contextMenus.create({ //// AUDIO
        "title": chrome.i18n.getMessage('ContextAudio'),
        "contexts": ["audio"], "onclick": handleContextMedia});
  }

  // UPDATE - Show icon on tabs
  chrome.tabs.onUpdated.addListener(function(tabId) {
    chrome.pageAction.show(tabId);
  });

  ///////////////////////// INTERACTION WITH THE BROWSER /////////////////////////

  // ICON clicked
  chrome.pageAction.onClicked.addListener(function(tab) {
    // We're processing...
    setTab('loading', 'UrlyProcessing', tab);
    shortenURL(tab.url, function (e, s) {
      if (!e) { // No error!
        setTab('16', 'UrlyShorten', tab);
        copyToClipboard(s); // Copy url and show notification - using url hash to transport the url
        var notification = webkitNotifications.createHTMLNotification('note.html#' + s + ' ' + tab.url);
        notification.show();
      } else { // Failed :/
        setTab('stop', 'UrlyFailed', tab);
        var notification = webkitNotifications.createNotification('graphics/stop.png',
            chrome.i18n.getMessage('UrlyFailed'),
            chrome.i18n.getMessage(s)
        );
        notification.show();
        // Hide error message and reset icon after a while
        setTimeout(function () {
          notification.cancel();
          setTab('16', 'UrlyShorten', tab);
        }, 10000);
      }
    });
  });

  // CONTEXT menu clicked
  function handleContextPage  (i, tab) { handleContext(i.pageUrl, tab); }
  function handleContextSel   (i, tab) { handleContext(i.selectionText, tab); }
  function handleContextLink  (i, tab) { handleContext(i.linkUrl, tab); }
  function handleContextMedia (i, tab) { handleContext(i.srcUrl, tab); }
  // Handle the click generally
  function handleContext(url, tab) {
    setTab('loading', 'UrlyProcessing', tab);
    shortenURL(url, function (e, s) {
      if (!e) { // No error!
        setTab('16', 'UrlyShorten', tab);
        copyToClipboard(s); // Copy url and show notification - using url hash to transport the url
        var notification = webkitNotifications.createHTMLNotification('note.html#' + s + ' ' + url);
        notification.show();
      } else { // Failed :/
        setTab('stop', 'UrlyFailed', tab);
        var notification = webkitNotifications.createNotification('graphics/stop.png',
            chrome.i18n.getMessage('UrlyFailed'),
            chrome.i18n.getMessage(s)
        );
        notification.show();
        // Hide error message and reset icon after a while
        setTimeout(function () {
          notification.cancel();
          setTab('16', 'UrlyShorten', tab);
        }, 10000);
      }
    });    
  }

  // OMNIBOX keyword: url
  chrome.omnibox.onInputEntered.addListener(function(text) {
    shortenURL(text, function (e, s) {
      if (!e) { // No error!
        copyToClipboard(s); // Copy url and show notification - using url hash to transport the url
        var notification = webkitNotifications.createHTMLNotification('note.html#' + s + ' ' + tab.url);
        notification.show();
      } else { // Failed :/
        var notification = webkitNotifications.createNotification('graphics/stop.png',
            chrome.i18n.getMessage('UrlyFailed'),
            chrome.i18n.getMessage(s)
        );
        notification.show(); // Show notification and hide it after 10 seconds
        setTimeout(function () {notification.cancel();}, 10000);
      }
    });
  });

  ///////////////////////// UTILITY AND HELPERS /////////////////////////

  // SHORTEN url and call callback(errors?, shortened/error text)
  function shortenURL(url, cb) {
    // Check if url seems rational (Thanks to Daring Fireball for the regex and searls (Justin Searls) for making it work in JS) - Added support for chrome:// links
    url = url.match(/\b((?:(https?|chrome):\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))/i);
    if (!url) { // url is null
      cb(true, 'FailFormat');
      return;
    } else {
      url = url[0];
    }
    // Now for the shortening!
    var xhr = new XMLHttpRequest(),
        urly = 'http://urly.fi/api/shorten/?url=' + escape(url);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {       cb(false, 'http://urly.fi/' + xhr.responseText);
        } else if (xhr.status === 403){ cb(true, 'FailFormat');
        } else if (xhr.status === 409){ cb(true, 'FailLimit');
        } else {                        cb(true, 'FailGeneral');}
      }
    }
    xhr.open('GET', urly, true);
    xhr.send();
  }

  // COPY text to clipboard
  function copyToClipboard(text) {
    var input = document.getElementById('url');
    if(!input) {return;}
    input.value = text;
    input.select();
    document.execCommand('copy', false, null);
  }

  // SET Icon and Tooltip to the omnibox
  function setTab(i, t, tab) {
    chrome.pageAction.setIcon({path: 'graphics/' + i + '.png', tabId: tab.id});
    chrome.pageAction.setTitle({title: chrome.i18n.getMessage(t), tabId: tab.id});
  };
</script>
</body>